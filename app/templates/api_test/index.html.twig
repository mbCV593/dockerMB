{% extends 'base.html.twig' %}

{% block title %}Test API{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>Endpoints Disponibles</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action" onclick="testAPI('/api/productos')">
                            <i class="fas fa-box"></i> GET /api/productos
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="testAPI('/api/productos/bajo-stock')">
                            <i class="fas fa-exclamation-triangle text-warning"></i> GET /api/productos/bajo-stock
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="testAPI('/api/usuarios')">
                            <i class="fas fa-users"></i> GET /api/usuarios
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="testAPI('/api/usuarios/activos')">
                            <i class="fas fa-user-check text-success"></i> GET /api/usuarios/activos
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="testAPI('/api/categorias')">
                            <i class="fas fa-tags"></i> GET /api/categorias
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="testAPI('/api/categorias/activas')">
                            <i class="fas fa-tag text-success"></i> GET /api/categorias/activas
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="testAPI('/api/inventario/estadisticas')">
                            <i class="fas fa-chart-bar text-info"></i> GET /api/inventario/estadisticas
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="testAPI('/api/inventario/resumen')">
                            <i class="fas fa-clipboard-list text-primary"></i> GET /api/inventario/resumen
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="testAPI('/api/inventario/movimientos')">
                            <i class="fas fa-exchange-alt text-secondary"></i> GET /api/inventario/movimientos
                        </a>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5>Estado de Conexión</h5>
                </div>
                <div class="card-body">
                    <div id="connection-status" class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Listo para probar
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Respuesta API</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearResponse()">
                            <i class="fas fa-trash"></i> Limpiar
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="formatJSON()">
                            <i class="fas fa-code"></i> Formatear
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="api-url" class="mb-3">
                        <strong>URL:</strong> <code id="current-url">Selecciona un endpoint</code>
                    </div>
                    <div id="api-status" class="mb-3"></div>
                    <pre id="api-response" class="bg-light p-3 border rounded" style="max-height: 500px; overflow-y: auto;">Selecciona un endpoint para ver la respuesta...</pre>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5>Test Personalizado</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="input-group">
                                <select class="form-select" id="method-select" style="max-width: 120px;">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                                <input type="text" class="form-control" id="custom-url" placeholder="/api/productos/1" />
                                <button class="btn btn-primary" onclick="testCustomAPI()">
                                    <i class="fas fa-play"></i> Ejecutar
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-info w-100" onclick="showAPIDocumentation()">
                                <i class="fas fa-book"></i> Ver Documentación
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para documentación -->
<div class="modal fade" id="docModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Documentación API</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Productos</h6>
                <ul>
                    <li><code>GET /api/productos</code> - Lista todos los productos</li>
                    <li><code>GET /api/productos/{id}</code> - Obtiene un producto específico</li>
                    <li><code>GET /api/productos/bajo-stock</code> - Productos con stock bajo</li>
                    <li><code>POST /api/productos</code> - Crear nuevo producto</li>
                </ul>

                <h6>Usuarios</h6>
                <ul>
                    <li><code>GET /api/usuarios</code> - Lista todos los usuarios</li>
                    <li><code>GET /api/usuarios/{id}</code> - Obtiene un usuario específico</li>
                    <li><code>GET /api/usuarios/activos</code> - Usuarios activos</li>
                    <li><code>POST /api/usuarios</code> - Crear nuevo usuario</li>
                </ul>

                <h6>Categorías</h6>
                <ul>
                    <li><code>GET /api/categorias</code> - Lista todas las categorías</li>
                    <li><code>GET /api/categorias/{id}</code> - Obtiene una categoría específica</li>
                    <li><code>GET /api/categorias/activas</code> - Categorías activas</li>
                    <li><code>GET /api/categorias/{id}/productos</code> - Productos de una categoría</li>
                </ul>

                <h6>Inventario</h6>
                <ul>
                    <li><code>GET /api/inventario/estadisticas</code> - Estadísticas generales</li>
                    <li><code>GET /api/inventario/resumen</code> - Resumen completo del inventario</li>
                    <li><code>GET /api/inventario/movimientos</code> - Historial de movimientos</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
async function testAPI(url) {
    updateConnectionStatus('testing', 'Probando endpoint...');
    document.getElementById('current-url').textContent = url;
    document.getElementById('api-response').textContent = 'Cargando...';
    document.getElementById('api-status').innerHTML = '';

    try {
        const startTime = performance.now();
        const response = await fetch(url);
        const endTime = performance.now();
        const responseTime = Math.round(endTime - startTime);

        const data = await response.json();
        
        const statusClass = response.ok ? 'success' : 'danger';
        document.getElementById('api-status').innerHTML = 
            `<span class="badge bg-${statusClass}">HTTP ${response.status}</span> 
             <span class="text-muted">Tiempo: ${responseTime}ms</span>`;

        document.getElementById('api-response').textContent = JSON.stringify(data, null, 2);

        if (response.ok) {
            updateConnectionStatus('success', 'Respuesta recibida correctamente');
        } else {
            updateConnectionStatus('error', `Error HTTP ${response.status}`);
        }
    } catch (error) {
        document.getElementById('api-response').textContent = 'Error: ' + error.message;
        document.getElementById('api-status').innerHTML = 
            `<span class="badge bg-danger">ERROR</span>`;
        updateConnectionStatus('error', 'Error de conexión: ' + error.message);
    }
}

async function testCustomAPI() {
    const method = document.getElementById('method-select').value;
    const url = document.getElementById('custom-url').value;
    
    if (!url) {
        alert('Por favor ingresa una URL');
        return;
    }

    updateConnectionStatus('testing', `Probando ${method} ${url}...`);
    document.getElementById('current-url').textContent = `${method} ${url}`;
    document.getElementById('api-response').textContent = 'Cargando...';

    try {
        const startTime = performance.now();
        const response = await fetch(url, { method: method });
        const endTime = performance.now();
        const responseTime = Math.round(endTime - startTime);

        const data = await response.json();
        
        const statusClass = response.ok ? 'success' : 'danger';
        document.getElementById('api-status').innerHTML = 
            `<span class="badge bg-${statusClass}">HTTP ${response.status}</span> 
             <span class="text-muted">Tiempo: ${responseTime}ms</span>`;

        document.getElementById('api-response').textContent = JSON.stringify(data, null, 2);

        if (response.ok) {
            updateConnectionStatus('success', 'Respuesta recibida correctamente');
        } else {
            updateConnectionStatus('error', `Error HTTP ${response.status}`);
        }
    } catch (error) {
        document.getElementById('api-response').textContent = 'Error: ' + error.message;
        document.getElementById('api-status').innerHTML = 
            `<span class="badge bg-danger">ERROR</span>`;
        updateConnectionStatus('error', 'Error de conexión: ' + error.message);
    }
}

function updateConnectionStatus(type, message) {
    const statusDiv = document.getElementById('connection-status');
    let className = 'alert-info';
    let icon = 'fas fa-info-circle';

    switch(type) {
        case 'testing':
            className = 'alert-warning';
            icon = 'fas fa-spinner fa-spin';
            break;
        case 'success':
            className = 'alert-success';
            icon = 'fas fa-check-circle';
            break;
        case 'error':
            className = 'alert-danger';
            icon = 'fas fa-exclamation-circle';
            break;
    }

    statusDiv.className = `alert ${className}`;
    statusDiv.innerHTML = `<i class="${icon}"></i> ${message}`;
}

function clearResponse() {
    document.getElementById('api-response').textContent = 'Selecciona un endpoint para ver la respuesta...';
    document.getElementById('current-url').textContent = 'Selecciona un endpoint';
    document.getElementById('api-status').innerHTML = '';
    updateConnectionStatus('info', 'Listo para probar');
}

function formatJSON() {
    const responseText = document.getElementById('api-response').textContent;
    try {
        const json = JSON.parse(responseText);
        document.getElementById('api-response').textContent = JSON.stringify(json, null, 2);
    } catch (e) {

    }
}

function showAPIDocumentation() {
    const modal = new bootstrap.Modal(document.getElementById('docModal'));
    modal.show();
}
</script>
{% endblock %}
